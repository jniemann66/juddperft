/*

MIT License

Copyright(c) 2016-2025 Judd Niemann

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files(the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and / or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions :

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

*/

//////////////////////////////////////////////
// movegen.h								//
// Defines:									//
// BitBoard, class Move, 					//
// class ChessPosition, 					//
// Move Generation Functions				//
// Bitboard fill functions					//
// Piece codes and other constants			//
//////////////////////////////////////////////

#ifndef _MOVEGEN
#define _MOVEGEN 1
#define _CRT_SECURE_NO_WARNINGS 1

#ifdef _MSC_VER
#include <intrin.h>
#else
#include <x86intrin.h>
#endif

#include <cstdint>
#include <vector>

// Build Options:
#define _USE_HASH 1								// if undefined, entire hash table system will be excluded from build
//
#define _USE_BITSCAN_INSTRUCTIONS 1				// if defined, use x86-64 BSR and BSF instructions (Only available on x86-64)
// #define _USE_POPCNT_INSTRUCTION 1			// if defined, use popcnt instruction (Intel: Nehalem or Higher, AMD: Barcelona or Higher)
// #define _USE_BITTEST_INSTRUCTION 1			// if defined, use the BT instruction (all Intels)

// on gcc, there is a non-standard extension, std::bitset::_Find_first()
// which allows scanning of the first "on" bit, but clang and MSVC don't have it
// also, it is unclear whether this is actually any faster than just looping through all 64 bits
#define _USE_BITSET_FIND_FIRST

// MACRO: BITSET_LOOP(x)
// runs a line of code (x) for each "on" bit in a std::bitset<64>
// this is typically used to get the indices of "on" squares in a BitBoard
// expected: an initialised std::bitset<64> called 'bs' ;-)

#if defined (_USE_BITSET_FIND_FIRST) && defined(__GNUC__) &&!defined(__clang__)
#define BITSET_LOOP(x) \
size_t bit; \
while ((bit = bs._Find_first()) != 64) { \
	(x); \
	bs.reset(bit); \
}
#else
#define BITSET_LOOP(x) \
for (int bit = 0; bit < 64; bit++) { \
	if (bs[bit]) { \
		(x); \
	} \
}
#endif

// #define _OLD_METHOD_FOR_SLIDING_PIECES

#ifndef SMALL_BUFFER_SIZE
#define SMALL_BUFFER_SIZE 64
#endif

#define MOVELIST_SIZE 256
#define CHECKMATE 9999
#define STALEMATE -1

//#define COUNT_MOVEGEN_CPU_CYCLES


namespace juddperft {

#ifdef COUNT_MOVEGEN_CPU_CYCLES
extern uint64_t movegen_call_count;
extern uint64_t movegen_total_cycles;
#endif

using piece_t = uint32_t;

enum Piece : piece_t {
	WEMPTY = 0,
	WPAWN = 1,
	WBISHOP = 2,
	WENPASSANT = 3,
	WROOK = 4,
	WKNIGHT = 5,
	WQUEEN = 6,
	WKING = 7,
	BEMPTY = 8,
	BPAWN = 9,
	BBISHOP = 10,
	BENPASSANT = 11,
	BROOK = 12,
	BKNIGHT = 13,
	BQUEEN = 14,
	BKING = 15
};

typedef uint64_t BitBoard;
typedef uint64_t HashKey;

// ChessMove{} - Compact move format packed into 64 bits
// From and To squares represented by unsigned char square index

struct ChessMove {
	bool BlackToMove{false};
	unsigned char Piece;
	unsigned char FromSquare;
	unsigned char ToSquare;

	union {
		struct {
			uint32_t MoveCount : 8;			// used in the first move of list; indicates how many moves there are
			uint32_t EndOfMoveList : 1;		// if set, this marks the end of the move list (not a move)
			uint32_t IllegalMove : 1;
			uint32_t Unused : 10;
			uint32_t DoublePawnMove : 1;
			uint32_t EnPassantCapture : 1;
			uint32_t Castle : 1;
			uint32_t CastleLong : 1;
			uint32_t Capture : 1;
			uint32_t Check : 1;				// if set, performing this move will put opponent in check
			uint32_t PromoteKnight : 1;
			uint32_t PromoteBishop : 1;
			uint32_t PromoteRook : 1;
			uint32_t PromoteQueen : 1;
			uint32_t Stalemate : 1;			// if set, performing this move will put opponent in checkmate
			uint32_t Checkmate : 1;			// if set, performing this move will result in stalemate
		};
		uint32_t Flags{0};
	};

	void ClearFlags() {
		Flags = 0;
	}

};


class ChessPosition
{
	/* --------------------------------------------------------------

			Explanation of Bit-Representation used in positions:

			D (msb):	Colour (1=Black)
			C			1=Straight-Moving Piece (Q or R)
			B			1=Diagonal-moving piece (Q or B)
			A (lsb):	1=Pawn

			D	C	B	A

	(0)		0	0	0	0	Empty Square
	(1)		0	0	0	1	White Pawn
	(2)		0	0	1	0	White Bishop
	(3)		0	0	1	1	White En passant Square
	(4)		0	1	0	0	White Rook
	(5)		0	1	0	1	White Knight
	(6)		0	1	1	0	White Queen
	(7)		0	1	1	1	White King
	(8)		1	0	0	0	Reserved-Don't use (Black empty square)
	(9)		1	0	0	1	Black Pawn
	(10)	1	0	1	0	Black Bishop
	(11)	1	0	1	1	Black En passant Square
	(12)	1	1	0	0	Black Rook
	(13)	1	1	0	1	Black Knight
	(14)	1	1	1	0	Black Queen
	(15)	1	1	1	1	Black King

	---------------------------------------------------------------*/

public:
	BitBoard A;
	BitBoard B;
	BitBoard C;
	BitBoard D;
	union{
		struct{
			uint32_t BlackToMove : 1;
			uint32_t WhiteCanCastle : 1;
			uint32_t WhiteCanCastleLong : 1;
			uint32_t BlackCanCastle : 1;
			uint32_t BlackCanCastleLong : 1;
			uint32_t WhiteForfeitedCastle : 1;
			uint32_t WhiteForfeitedCastleLong : 1;
			uint32_t BlackForfeitedCastle : 1;
			uint32_t BlackForfeitedCastleLong : 1;
			uint32_t WhiteDidCastle : 1;
			uint32_t WhiteDidCastleLong : 1;
			uint32_t BlackDidCastle : 1;
			uint32_t BlackDidCastleLong : 1;
			uint32_t Unused : 12;
			uint32_t DontGenerateAllMoves : 1; // flag to signal to move generator to not bother find all moves, but to find at least one legal move
			uint32_t WhiteIsInCheck : 1;
			uint32_t BlackIsInCheck : 1;
			uint32_t WhiteIsStalemated : 1;
			uint32_t BlackIsStalemated : 1;
			uint32_t WhiteIsCheckmated : 1;
			uint32_t BlackIsCheckmated : 1;
		};
		uint32_t Flags;
	};
	uint16_t MoveNumber;
	uint16_t HalfMoves;
	bool operator==(const ChessPosition& Q) {
		return((ChessPosition::A == Q.A) && (ChessPosition::B == Q.B) && (ChessPosition::C == Q.C) && (ChessPosition::D == Q.D) && (ChessPosition::Flags == Q.Flags));
	}

#ifdef _USE_HASH
	HashKey HK;
#endif

public:
	ChessPosition();
	ChessPosition& setupStartPosition();

#ifdef _USE_HASH
	ChessPosition& calculateHash();
#endif

	ChessPosition& setPieceAtSquare(const piece_t& piece,  unsigned int s)
	{
		const BitBoard S = 1LL << s;

		// clear the square
		A &= ~S;
		B &= ~S;
		C &= ~S;
		D &= ~S;

		// Populate the square
		A |= static_cast<int64_t>(piece & 1) << s;
		B |= static_cast<int64_t>((piece & 2) >> 1) << s;
		C |= static_cast<int64_t>((piece & 4) >> 2) << s;
		D |= static_cast<int64_t>((piece & 8) >> 3) << s;

#ifdef _USE_HASH
		ChessPosition::calculateHash();
#endif

		return *this;
	}

	piece_t getPieceAtSquare(unsigned int q) const
	{
		const BitBoard S = 1LL << q;

		BitBoard V = (D & S) >> q;
		V <<= 1;
		V |= (C & S) >> q;
		V <<= 1;
		V |= (B & S) >> q;
		V <<= 1;
		V |= (A & S) >> q;

		return static_cast<piece_t>(V);
	}

	ChessPosition& performMove(ChessMove M);
	std::vector<ChessMove> getLegalMoves() const;
	void getLegalMoves(ChessMove *movelist) const;

	void switchSides();
	void clear(void);
	int calculateMaterial() const;

private:
};


/////////////////////////////////////////////
// Move notation styles:
// ---------------------
// LongAlgebraic: e7xf8(q)
// StandardAlgebraic: exf(q)
// CoOrdinate: e7f8q
/////////////////////////////////////////////

enum MoveNotationStyle{
	LongAlgebraic,
	StandardAlgebraic,
	CoOrdinate,
	Diagnostic,
	LongAlgebraicNoNewline
};

// Move-Generation (and verification)
void generateMoves(const ChessPosition & P, ChessMove * pM);
bool isInCheck(const ChessPosition& P, bool bIsBlack);

// White Move-Generation Functions:
void genWhiteMoves(const ChessPosition& P, ChessMove*);
inline BitBoard genBlackAttacks(const ChessPosition& Z);
BitBoard isWhiteInCheck(const ChessPosition & Z);
void scanWhiteMoveForChecks(ChessPosition& Q, ChessMove* pM); // detects whether white's proposed move will put black in check or checkmate. updates pM->Check and pM->Checkmate
void addWhiteCastlingMoveIfLegal(const ChessPosition& P, ChessMove*& pM, int32_t flags = 0);
void addWhiteMoveToListIfLegal(const ChessPosition & P, ChessMove *& pM, unsigned char fromsquare, BitBoard to, int32_t piece, int32_t flags = 0);
void addWhitePromotionsToListIfLegal(const ChessPosition & P, ChessMove *& pM, unsigned char fromsquare, BitBoard to);

// Black Move-Generation Functions:
void genBlackMoves(const ChessPosition& P, ChessMove*);
inline BitBoard genWhiteAttacks(const ChessPosition& Z);
BitBoard isBlackInCheck(const ChessPosition & Z);
void scanBlackMoveForChecks(ChessPosition& Q, ChessMove* pM); // detects whether black's proposed move will put white in check or checkmate. updates pM->Check and pM->Checkmate
void addBlackCastlingMoveToListIfLegal(const ChessPosition& P, ChessMove*& pM, int32_t flags = 0);
void addBlackMoveToListIfLegal(const ChessPosition & P, ChessMove *& pM, unsigned char fromsquare, BitBoard to, int32_t piece, int32_t flags = 0);
void addBlackPromotionsToListIfLegal(const ChessPosition & P, ChessMove *& pM, unsigned char fromsquare, BitBoard to);

// Dump I/O functions:
void dumpBitBoard(BitBoard b);
void dumpChessPosition(ChessPosition p);
void dumpMove(const ChessMove& mv, MoveNotationStyle style = LongAlgebraic, char *pBuffer = nullptr, const ChessMove *movelist = nullptr);
void dumpMoveList(ChessMove * pMoveList, MoveNotationStyle style = LongAlgebraic, char *pBuffer = nullptr);

// Compound Bitboard Fill operations:
BitBoard fillStraightAttacksOccluded(BitBoard g, BitBoard p);
BitBoard fillDiagonalAttacksOccluded(BitBoard g, BitBoard p);
BitBoard fillKingAttacksOccluded(BitBoard g, BitBoard p);
BitBoard fillKingAttacks(BitBoard g);
BitBoard fillKnightAttacksOccluded(BitBoard g, BitBoard p);

// Fill and Move Bitboard Operations:
BitBoard fillRightOccluded(BitBoard g, BitBoard p);
BitBoard fillLeftOccluded(BitBoard g, BitBoard p);
BitBoard fillUpOccluded(BitBoard g, BitBoard p);
BitBoard fillDownOccluded(BitBoard g, BitBoard p);

BitBoard fillUpRightOccluded(BitBoard g, BitBoard p);
BitBoard fillDownRightOccluded(BitBoard g, BitBoard p);
BitBoard fillDownLeftOccluded(BitBoard g, BitBoard p);
BitBoard fillUpLeftOccluded(BitBoard g, BitBoard p);

BitBoard moveUpSingleOccluded(BitBoard g, BitBoard p);
BitBoard moveUpRightSingleOccluded(BitBoard g, BitBoard p);
BitBoard moveRightSingleOccluded(BitBoard g, BitBoard p);
BitBoard moveDownRightSingleOccluded(BitBoard g, BitBoard p);
BitBoard moveDownSingleOccluded(BitBoard g, BitBoard p);
BitBoard moveDownLeftSingleOccluded(BitBoard g, BitBoard p);
BitBoard moveLeftSingleOccluded(BitBoard g, BitBoard p);
BitBoard moveUpLeftSingleOccluded(BitBoard g, BitBoard p);

BitBoard moveKnight1Occluded(BitBoard g, BitBoard p);
BitBoard moveKnight2Occluded(BitBoard g, BitBoard p);
BitBoard moveKnight3Occluded(BitBoard g, BitBoard p);
BitBoard moveKnight4Occluded(BitBoard g, BitBoard p);
BitBoard moveKnight5Occluded(BitBoard g, BitBoard p);
BitBoard moveKnight6Occluded(BitBoard g, BitBoard p);
BitBoard moveKnight7Occluded(BitBoard g, BitBoard p);
BitBoard moveKnight8Occluded(BitBoard g, BitBoard p);

/* --------------------------------------------------------------
Deafault material values of Pieces:
---------------------------------------------------------------*/

const int pieceMaterialValue[16] =
{
	0,			// Empty Square
	100,		// White pawn
	300,		// White Bishop
	0,			// White En passant Square
	500,		// White Rook
	300,		// White Knight
	900,		// White Queen
	0,			// White King
	0,			// Unused
	-100,		// Black Pawn
	-300,		// Black Bishop
	0,			// Black En passant Square
	-500,		// Black Rook
	-300,		// Black Knight
	-900		// Black Queen
	,0			// Black King
};

// all the square indexes
enum class SquareIndex : unsigned char {
	h1 = 0,
		g1, f1, e1, d1, c1, b1, a1,
	h2, g2, f2, e2, d2, c2, b2, a2,
	h3, g3, f3, e3, d3, c3, b3, a3,
	h4, g4, f4, e4, d4, c4, b4, a4,
	h5, g5, f5, e5, d5, c5, b5, a5,
	h6, g6, f6, e6, d6, c6, b6, a6,
	h7, g7, f7, e7, d7, c7, b7, a7,
	h8, g8, f8, e8, d8, c8, b8, a8 = 63
};

// all the squares in binary (Bitboard) representation
enum SQUARES : uint64_t {
	H1 = 0x0000000000000001,
	G1 = 0x0000000000000002,
	F1 = 0x0000000000000004,
	E1 = 0x0000000000000008,
	D1 = 0x0000000000000010,
	C1 = 0x0000000000000020,
	B1 = 0x0000000000000040,
	A1 = 0x0000000000000080,

	H2 = 0x0000000000000100,
	G2 = 0x0000000000000200,
	F2 = 0x0000000000000400,
	E2 = 0x0000000000000800,
	D2 = 0x0000000000001000,
	C2 = 0x0000000000002000,
	B2 = 0x0000000000004000,
	A2 = 0x0000000000008000,

	H3 = 0x0000000000010000,
	G3 = 0x0000000000020000,
	F3 = 0x0000000000040000,
	E3 = 0x0000000000080000,
	D3 = 0x0000000000100000,
	C3 = 0x0000000000200000,
	B3 = 0x0000000000400000,
	A3 = 0x0000000000800000,

	H4 = 0x0000000001000000,
	G4 = 0x0000000002000000,
	F4 = 0x0000000004000000,
	E4 = 0x0000000008000000,
	D4 = 0x0000000010000000,
	C4 = 0x0000000020000000,
	B4 = 0x0000000040000000,
	A4 = 0x0000000080000000,

	H5 = 0x0000000100000000,
	G5 = 0x0000000200000000,
	F5 = 0x0000000400000000,
	E5 = 0x0000000800000000,
	D5 = 0x0000001000000000,
	C5 = 0x0000002000000000,
	B5 = 0x0000004000000000,
	A5 = 0x0000008000000000,

	H6 = 0x0000010000000000,
	G6 = 0x0000020000000000,
	F6 = 0x0000040000000000,
	E6 = 0x0000080000000000,
	D6 = 0x0000100000000000,
	C6 = 0x0000200000000000,
	B6 = 0x0000400000000000,
	A6 = 0x0000800000000000,

	H7 = 0x0001000000000000,
	G7 = 0x0002000000000000,
	F7 = 0x0004000000000000,
	E7 = 0x0008000000000000,
	D7 = 0x0010000000000000,
	C7 = 0x0020000000000000,
	B7 = 0x0040000000000000,
	A7 = 0x0080000000000000,

	H8 = 0x0100000000000000,
	G8 = 0x0200000000000000,
	F8 = 0x0400000000000000,
	E8 = 0x0800000000000000,
	D8 = 0x1000000000000000,
	C8 = 0x2000000000000000,
	B8 = 0x4000000000000000,
	A8 = 0x8000000000000000
};

// Common board regions in binary (Bitboard) format
enum Regions : BitBoard {
	RANK1 = 0x00000000000000ff,
	RANK2 = 0x000000000000ff00,
	RANK3 = 0x0000000000ff0000,
	RANK4 = 0x00000000ff000000,
	RANK5 = 0x000000ff00000000,
	RANK6 = 0x0000ff0000000000,
	RANK7 = 0x00ff000000000000,
	RANK8 = 0xff00000000000000,

	FILEA = 0x8080808080808080,
	FILEB = 0x4040404040404040,
	FILEC = 0x2020202020202020,
	FILED = 0x1010101010101010,
	FILEE = 0x0808080808080808,
	FILEF = 0x0404040404040404,
	FILEG = 0x0202020202020202,
	FILEH = 0x0101010101010101,

	RIM	= 0xff818181818181ff,
	UPPER_CENTRE = 0x0000001800000000,
	LOWER_CENTRE = 0x0000000018000000,

	WHITECASTLEZONE	= 0x0000000000000006,
	BLACKCASTLEZONE	= 0x0600000000000000,
	WHITECASTLELONGZONE	= 0x0000000000000070,
	BLACKCASTLELONGZONE	= 0x7000000000000000,
	WHITEOUTPOSTZONE = 0x0000ffffff000000,
	BLACKOUTPOSTZONE = 0x000000ffffff0000,

	WHITEQRPOS = 0x0000000000000080,
	WHITEQNPOS = 0x0000000000000040,
	WHITEQBPOS = 0x0000000000000020,
	WHITEQUEENPOS = 0x0000000000000010,
	WHITEKINGPOS = 0x0000000000000008,
	WHITEKBPOS = 0x0000000000000004,
	WHITEKNPOS = 0x0000000000000002,
	WHITEKRPOS = 0x0000000000000001,

	BLACKQRPOS = 0x8000000000000000,
	BLACKQNPOS = 0x4000000000000000,
	BLACKQBPOS = 0x2000000000000000,
	BLACKQUEENPOS = 0x1000000000000000,
	BLACKKINGPOS = 0x0800000000000000,
	BLACKKBPOS  = 0x0400000000000000,
	BLACKKNPOS = 0x0200000000000000,
	BLACKKRPOS = 0x0100000000000000,

	LEFTMASK  = 0xfefefefefefefefe,
	RIGHTMASK = 0x7f7f7f7f7f7f7f7f
};

// Pre-calculated move tables: BitBoards

const BitBoard MoveUp[64] = {
	0x0000000000000100, 0x0000000000000200, 0x0000000000000400, 0x0000000000000800, 0x00000000001000, 0x0000000000002000, 0x0000000000004000, 0x0000000000008000,
	0x0000000000010000, 0x0000000000020000, 0x0000000000040000, 0x0000000000080000, 0x00000000100000, 0x0000000000200000, 0x0000000000400000, 0x0000000000800000,
	0x0000000001000000, 0x0000000002000000, 0x0000000004000000, 0x0000000008000000, 0x00000010000000, 0x0000000020000000, 0x0000000040000000, 0x0000000080000000,
	0x0000000100000000, 0x0000000200000000, 0x0000000400000000, 0x0000000800000000, 0x00001000000000, 0x0000002000000000, 0x0000004000000000, 0x0000008000000000,
	0x0000010000000000, 0x0000020000000000, 0x0000040000000000, 0x0000080000000000, 0x00100000000000, 0x0000200000000000, 0x0000400000000000, 0x0000800000000000,
	0x0001000000000000, 0x0002000000000000, 0x0004000000000000, 0x0008000000000000, 0x10000000000000, 0x0020000000000000, 0x0040000000000000, 0x0080000000000000,
	0x0100000000000000, 0x0200000000000000, 0x0400000000000000, 0x0800000000000000, 0x1000000000000000, 0x2000000000000000, 0x4000000000000000, 0x8000000000000000,
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000
};

const BitBoard MoveUpRight[64] = {
	000000000000000000, 0x0000000000000100, 0x0000000000000200, 0x0000000000000400, 0x00000000000800, 0x0000000000001000, 0x0000000000002000, 0x0000000000004000,
	000000000000000000, 0x0000000000010000, 0x0000000000020000, 0x0000000000040000, 0x00000000080000, 0x0000000000100000, 0x0000000000200000, 0x0000000000400000,
	000000000000000000, 0x0000000001000000, 0x0000000002000000, 0x0000000004000000, 0x00000008000000, 0x0000000010000000, 0x0000000020000000, 0x0000000040000000,
	000000000000000000, 0x0000000100000000, 0x0000000200000000, 0x0000000400000000, 0x00000800000000, 0x0000001000000000, 0x0000002000000000, 0x0000004000000000,
	000000000000000000, 0x0000010000000000, 0x0000020000000000, 0x0000040000000000, 0x00080000000000, 0x0000100000000000, 0x0000200000000000, 0x0000400000000000,
	000000000000000000, 0x0001000000000000, 0x0002000000000000, 0x0004000000000000, 0x08000000000000, 0x0010000000000000, 0x0020000000000000, 0x0040000000000000,
	000000000000000000, 0x0100000000000000, 0x0200000000000000, 0x0400000000000000, 0x800000000000000, 0x1000000000000000, 0x2000000000000000, 0x4000000000000000,
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000
};

const BitBoard MoveRight[64] = {
	000000000000000000, 0x0000000000000001, 0x0000000000000002, 0x0000000000000004, 0x00000000000008, 0x0000000000000010, 0x0000000000000020, 0x0000000000000040,
	000000000000000000, 0x0000000000000100, 0x0000000000000200, 0x0000000000000400, 0x00000000000800, 0x0000000000001000, 0x0000000000002000, 0x0000000000004000,
	000000000000000000, 0x0000000000010000, 0x0000000000020000, 0x0000000000040000, 0x00000000080000, 0x0000000000100000, 0x0000000000200000, 0x0000000000400000,
	000000000000000000, 0x0000000001000000, 0x0000000002000000, 0x0000000004000000, 0x00000008000000, 0x0000000010000000, 0x0000000020000000, 0x0000000040000000,
	000000000000000000, 0x0000000100000000, 0x0000000200000000, 0x0000000400000000, 0x00000800000000, 0x0000001000000000, 0x0000002000000000, 0x0000004000000000,
	000000000000000000, 0x0000010000000000, 0x0000020000000000, 0x0000040000000000, 0x00080000000000, 0x0000100000000000, 0x0000200000000000, 0x0000400000000000,
	000000000000000000, 0x0001000000000000, 0x0002000000000000, 0x0004000000000000, 0x08000000000000, 0x0010000000000000, 0x0020000000000000, 0x0040000000000000,
	000000000000000000, 0x0100000000000000, 0x0200000000000000, 0x0400000000000000, 0x800000000000000, 0x1000000000000000, 0x2000000000000000, 0x4000000000000000
};

const BitBoard MoveDownRight[64] = {
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000,
	000000000000000000, 0x0000000000000001, 0x0000000000000002, 0x0000000000000004, 0x00000000000008, 0x0000000000000010, 0x0000000000000020, 0x0000000000000040,
	000000000000000000, 0x0000000000000100, 0x0000000000000200, 0x0000000000000400, 0x00000000000800, 0x0000000000001000, 0x0000000000002000, 0x0000000000004000,
	000000000000000000, 0x0000000000010000, 0x0000000000020000, 0x0000000000040000, 0x00000000080000, 0x0000000000100000, 0x0000000000200000, 0x0000000000400000,
	000000000000000000, 0x0000000001000000, 0x0000000002000000, 0x0000000004000000, 0x00000008000000, 0x0000000010000000, 0x0000000020000000, 0x0000000040000000,
	000000000000000000, 0x0000000100000000, 0x0000000200000000, 0x0000000400000000, 0x00000800000000, 0x0000001000000000, 0x0000002000000000, 0x0000004000000000,
	000000000000000000, 0x0000010000000000, 0x0000020000000000, 0x0000040000000000, 0x00080000000000, 0x0000100000000000, 0x0000200000000000, 0x0000400000000000,
	000000000000000000, 0x0001000000000000, 0x0002000000000000, 0x0004000000000000, 0x08000000000000, 0x0010000000000000, 0x0020000000000000, 0x0040000000000000
};

const BitBoard MoveDown[64] = {
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000,
	0x0000000000000001, 0x0000000000000002, 0x0000000000000004, 0x0000000000000008, 0x00000000000010, 0x0000000000000020, 0x0000000000000040, 0x0000000000000080,
	0x0000000000000100, 0x0000000000000200, 0x0000000000000400, 0x0000000000000800, 0x00000000001000, 0x0000000000002000, 0x0000000000004000, 0x0000000000008000,
	0x0000000000010000, 0x0000000000020000, 0x0000000000040000, 0x0000000000080000, 0x00000000100000, 0x0000000000200000, 0x0000000000400000, 0x0000000000800000,
	0x0000000001000000, 0x0000000002000000, 0x0000000004000000, 0x0000000008000000, 0x00000010000000, 0x0000000020000000, 0x0000000040000000, 0x0000000080000000,
	0x0000000100000000, 0x0000000200000000, 0x0000000400000000, 0x0000000800000000, 0x00001000000000, 0x0000002000000000, 0x0000004000000000, 0x0000008000000000,
	0x0000010000000000, 0x0000020000000000, 0x0000040000000000, 0x0000080000000000, 0x00100000000000, 0x0000200000000000, 0x0000400000000000, 0x0000800000000000,
	0x0001000000000000, 0x0002000000000000, 0x0004000000000000, 0x0008000000000000, 0x10000000000000, 0x0020000000000000, 0x0040000000000000, 0x0080000000000000
};

const BitBoard MoveDownLeft[64] = {
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000,
	0x0000000000000002, 0x0000000000000004, 0x0000000000000008, 0x0000000000000010, 0x00000000000020, 0x0000000000000040, 0x0000000000000080, 000000000000000000,
	0x0000000000000200, 0x0000000000000400, 0x0000000000000800, 0x0000000000001000, 0x00000000002000, 0x0000000000004000, 0x0000000000008000, 000000000000000000,
	0x0000000000020000, 0x0000000000040000, 0x0000000000080000, 0x0000000000100000, 0x00000000200000, 0x0000000000400000, 0x0000000000800000, 000000000000000000,
	0x0000000002000000, 0x0000000004000000, 0x0000000008000000, 0x0000000010000000, 0x00000020000000, 0x0000000040000000, 0x0000000080000000, 000000000000000000,
	0x0000000200000000, 0x0000000400000000, 0x0000000800000000, 0x0000001000000000, 0x00002000000000, 0x0000004000000000, 0x0000008000000000, 000000000000000000,
	0x0000020000000000, 0x0000040000000000, 0x0000080000000000, 0x0000100000000000, 0x00200000000000, 0x0000400000000000, 0x0000800000000000, 000000000000000000,
	0x0002000000000000, 0x0004000000000000, 0x0008000000000000, 0x0010000000000000, 0x20000000000000, 0x0040000000000000, 0x0080000000000000, 000000000000000000
};

const BitBoard MoveLeft[64] = {
	0x0000000000000002, 0x0000000000000004, 0x0000000000000008, 0x0000000000000010, 0x00000000000020, 0x0000000000000040, 0x0000000000000080, 000000000000000000,
	0x0000000000000200, 0x0000000000000400, 0x0000000000000800, 0x0000000000001000, 0x00000000002000, 0x0000000000004000, 0x0000000000008000, 000000000000000000,
	0x0000000000020000, 0x0000000000040000, 0x0000000000080000, 0x0000000000100000, 0x00000000200000, 0x0000000000400000, 0x0000000000800000, 000000000000000000,
	0x0000000002000000, 0x0000000004000000, 0x0000000008000000, 0x0000000010000000, 0x00000020000000, 0x0000000040000000, 0x0000000080000000, 000000000000000000,
	0x0000000200000000, 0x0000000400000000, 0x0000000800000000, 0x0000001000000000, 0x00002000000000, 0x0000004000000000, 0x0000008000000000, 000000000000000000,
	0x0000020000000000, 0x0000040000000000, 0x0000080000000000, 0x0000100000000000, 0x00200000000000, 0x0000400000000000, 0x0000800000000000, 000000000000000000,
	0x0002000000000000, 0x0004000000000000, 0x0008000000000000, 0x0010000000000000, 0x20000000000000, 0x0040000000000000, 0x0080000000000000, 000000000000000000,
	0x0200000000000000, 0x0400000000000000, 0x0800000000000000, 0x1000000000000000, 0x2000000000000000, 0x4000000000000000, 0x8000000000000000, 000000000000000000
};

const BitBoard MoveUpLeft[64] = {
	0x0000000000000200, 0x0000000000000400, 0x0000000000000800, 0x0000000000001000, 0x00000000002000, 0x0000000000004000, 0x0000000000008000, 000000000000000000,
	0x0000000000020000, 0x0000000000040000, 0x0000000000080000, 0x0000000000100000, 0x00000000200000, 0x0000000000400000, 0x0000000000800000, 000000000000000000,
	0x0000000002000000, 0x0000000004000000, 0x0000000008000000, 0x0000000010000000, 0x00000020000000, 0x0000000040000000, 0x0000000080000000, 000000000000000000,
	0x0000000200000000, 0x0000000400000000, 0x0000000800000000, 0x0000001000000000, 0x00002000000000, 0x0000004000000000, 0x0000008000000000, 000000000000000000,
	0x0000020000000000, 0x0000040000000000, 0x0000080000000000, 0x0000100000000000, 0x00200000000000, 0x0000400000000000, 0x0000800000000000, 000000000000000000,
	0x0002000000000000, 0x0004000000000000, 0x0008000000000000, 0x0010000000000000, 0x20000000000000, 0x0040000000000000, 0x0080000000000000, 000000000000000000,
	0x0200000000000000, 0x0400000000000000, 0x0800000000000000, 0x1000000000000000, 0x2000000000000000, 0x4000000000000000, 0x8000000000000000, 000000000000000000,
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000
};

const BitBoard MoveKnight1[64] = {
	000000000000000000, 0x0000000000010000, 0x0000000000020000, 0x0000000000040000, 0x00000000080000, 0x0000000000100000, 0x0000000000200000, 0x0000000000400000,
	000000000000000000, 0x0000000001000000, 0x0000000002000000, 0x0000000004000000, 0x00000008000000, 0x0000000010000000, 0x0000000020000000, 0x0000000040000000,
	000000000000000000, 0x0000000100000000, 0x0000000200000000, 0x0000000400000000, 0x00000800000000, 0x0000001000000000, 0x0000002000000000, 0x0000004000000000,
	000000000000000000, 0x0000010000000000, 0x0000020000000000, 0x0000040000000000, 0x00080000000000, 0x0000100000000000, 0x0000200000000000, 0x0000400000000000,
	000000000000000000, 0x0001000000000000, 0x0002000000000000, 0x0004000000000000, 0x08000000000000, 0x0010000000000000, 0x0020000000000000, 0x0040000000000000,
	000000000000000000, 0x0100000000000000, 0x0200000000000000, 0x0400000000000000, 0x800000000000000, 0x1000000000000000, 0x2000000000000000, 0x4000000000000000,
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000,
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000
};

const BitBoard MoveKnight2[64] = {
	000000000000000000, 000000000000000000, 0x0000000000000100, 0x0000000000000200, 0x00000000000400, 0x0000000000000800, 0x0000000000001000, 0x0000000000002000,
	000000000000000000, 000000000000000000, 0x0000000000010000, 0x0000000000020000, 0x00000000040000, 0x0000000000080000, 0x0000000000100000, 0x0000000000200000,
	000000000000000000, 000000000000000000, 0x0000000001000000, 0x0000000002000000, 0x00000004000000, 0x0000000008000000, 0x0000000010000000, 0x0000000020000000,
	000000000000000000, 000000000000000000, 0x0000000100000000, 0x0000000200000000, 0x00000400000000, 0x0000000800000000, 0x0000001000000000, 0x0000002000000000,
	000000000000000000, 000000000000000000, 0x0000010000000000, 0x0000020000000000, 0x00040000000000, 0x0000080000000000, 0x0000100000000000, 0x0000200000000000,
	000000000000000000, 000000000000000000, 0x0001000000000000, 0x0002000000000000, 0x04000000000000, 0x0008000000000000, 0x0010000000000000, 0x0020000000000000,
	000000000000000000, 000000000000000000, 0x0100000000000000, 0x0200000000000000, 0x400000000000000, 0x0800000000000000, 0x1000000000000000, 0x2000000000000000,
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000
};

const BitBoard MoveKnight3[64] = {
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000,
	000000000000000000, 000000000000000000, 0x0000000000000001, 0x0000000000000002, 0x00000000000004, 0x0000000000000008, 0x0000000000000010, 0x0000000000000020,
	000000000000000000, 000000000000000000, 0x0000000000000100, 0x0000000000000200, 0x00000000000400, 0x0000000000000800, 0x0000000000001000, 0x0000000000002000,
	000000000000000000, 000000000000000000, 0x0000000000010000, 0x0000000000020000, 0x00000000040000, 0x0000000000080000, 0x0000000000100000, 0x0000000000200000,
	000000000000000000, 000000000000000000, 0x0000000001000000, 0x0000000002000000, 0x00000004000000, 0x0000000008000000, 0x0000000010000000, 0x0000000020000000,
	000000000000000000, 000000000000000000, 0x0000000100000000, 0x0000000200000000, 0x00000400000000, 0x0000000800000000, 0x0000001000000000, 0x0000002000000000,
	000000000000000000, 000000000000000000, 0x0000010000000000, 0x0000020000000000, 0x00040000000000, 0x0000080000000000, 0x0000100000000000, 0x0000200000000000,
	000000000000000000, 000000000000000000, 0x0001000000000000, 0x0002000000000000, 0x04000000000000, 0x0008000000000000, 0x0010000000000000, 0x0020000000000000
};

const BitBoard MoveKnight4[64] = {
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000,
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000,
	000000000000000000, 0x0000000000000001, 0x0000000000000002, 0x0000000000000004, 0x00000000000008, 0x0000000000000010, 0x0000000000000020, 0x0000000000000040,
	000000000000000000, 0x0000000000000100, 0x0000000000000200, 0x0000000000000400, 0x00000000000800, 0x0000000000001000, 0x0000000000002000, 0x0000000000004000,
	000000000000000000, 0x0000000000010000, 0x0000000000020000, 0x0000000000040000, 0x00000000080000, 0x0000000000100000, 0x0000000000200000, 0x0000000000400000,
	000000000000000000, 0x0000000001000000, 0x0000000002000000, 0x0000000004000000, 0x00000008000000, 0x0000000010000000, 0x0000000020000000, 0x0000000040000000,
	000000000000000000, 0x0000000100000000, 0x0000000200000000, 0x0000000400000000, 0x00000800000000, 0x0000001000000000, 0x0000002000000000, 0x0000004000000000,
	000000000000000000, 0x0000010000000000, 0x0000020000000000, 0x0000040000000000, 0x00080000000000, 0x0000100000000000, 0x0000200000000000, 0x0000400000000000
};

const BitBoard MoveKnight5[64] = {
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000,
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000,
	0x0000000000000002, 0x0000000000000004, 0x0000000000000008, 0x0000000000000010, 0x00000000000020, 0x0000000000000040, 0x0000000000000080, 000000000000000000,
	0x0000000000000200, 0x0000000000000400, 0x0000000000000800, 0x0000000000001000, 0x00000000002000, 0x0000000000004000, 0x0000000000008000, 000000000000000000,
	0x0000000000020000, 0x0000000000040000, 0x0000000000080000, 0x0000000000100000, 0x00000000200000, 0x0000000000400000, 0x0000000000800000, 000000000000000000,
	0x0000000002000000, 0x0000000004000000, 0x0000000008000000, 0x0000000010000000, 0x00000020000000, 0x0000000040000000, 0x0000000080000000, 000000000000000000,
	0x0000000200000000, 0x0000000400000000, 0x0000000800000000, 0x0000001000000000, 0x00002000000000, 0x0000004000000000, 0x0000008000000000, 000000000000000000,
	0x0000020000000000, 0x0000040000000000, 0x0000080000000000, 0x0000100000000000, 0x00200000000000, 0x0000400000000000, 0x0000800000000000, 000000000000000000
};

const BitBoard MoveKnight6[64] = {
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000,
	0x0000000000000004, 0x0000000000000008, 0x0000000000000010, 0x0000000000000020, 0x00000000000040, 0x0000000000000080, 000000000000000000, 000000000000000000,
	0x0000000000000400, 0x0000000000000800, 0x0000000000001000, 0x0000000000002000, 0x00000000004000, 0x0000000000008000, 000000000000000000, 000000000000000000,
	0x0000000000040000, 0x0000000000080000, 0x0000000000100000, 0x0000000000200000, 0x00000000400000, 0x0000000000800000, 000000000000000000, 000000000000000000,
	0x0000000004000000, 0x0000000008000000, 0x0000000010000000, 0x0000000020000000, 0x00000040000000, 0x0000000080000000, 000000000000000000, 000000000000000000,
	0x0000000400000000, 0x0000000800000000, 0x0000001000000000, 0x0000002000000000, 0x00004000000000, 0x0000008000000000, 000000000000000000, 000000000000000000,
	0x0000040000000000, 0x0000080000000000, 0x0000100000000000, 0x0000200000000000, 0x00400000000000, 0x0000800000000000, 000000000000000000, 000000000000000000,
	0x0004000000000000, 0x0008000000000000, 0x0010000000000000, 0x0020000000000000, 0x40000000000000, 0x0080000000000000, 000000000000000000, 000000000000000000
};

const BitBoard MoveKnight7[64] = {
	0x0000000000000400, 0x0000000000000800, 0x0000000000001000, 0x0000000000002000, 0x00000000004000, 0x0000000000008000, 000000000000000000, 000000000000000000,
	0x0000000000040000, 0x0000000000080000, 0x0000000000100000, 0x0000000000200000, 0x00000000400000, 0x0000000000800000, 000000000000000000, 000000000000000000,
	0x0000000004000000, 0x0000000008000000, 0x0000000010000000, 0x0000000020000000, 0x00000040000000, 0x0000000080000000, 000000000000000000, 000000000000000000,
	0x0000000400000000, 0x0000000800000000, 0x0000001000000000, 0x0000002000000000, 0x00004000000000, 0x0000008000000000, 000000000000000000, 000000000000000000,
	0x0000040000000000, 0x0000080000000000, 0x0000100000000000, 0x0000200000000000, 0x00400000000000, 0x0000800000000000, 000000000000000000, 000000000000000000,
	0x0004000000000000, 0x0008000000000000, 0x0010000000000000, 0x0020000000000000, 0x40000000000000, 0x0080000000000000, 000000000000000000, 000000000000000000,
	0x0400000000000000, 0x0800000000000000, 0x1000000000000000, 0x2000000000000000, 0x4000000000000000, 0x8000000000000000, 000000000000000000, 000000000000000000,
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000
};

const BitBoard MoveKnight8[64] = {
	0x0000000000020000, 0x0000000000040000, 0x0000000000080000, 0x0000000000100000, 0x00000000200000, 0x0000000000400000, 0x0000000000800000, 000000000000000000,
	0x0000000002000000, 0x0000000004000000, 0x0000000008000000, 0x0000000010000000, 0x00000020000000, 0x0000000040000000, 0x0000000080000000, 000000000000000000,
	0x0000000200000000, 0x0000000400000000, 0x0000000800000000, 0x0000001000000000, 0x00002000000000, 0x0000004000000000, 0x0000008000000000, 000000000000000000,
	0x0000020000000000, 0x0000040000000000, 0x0000080000000000, 0x0000100000000000, 0x00200000000000, 0x0000400000000000, 0x0000800000000000, 000000000000000000,
	0x0002000000000000, 0x0004000000000000, 0x0008000000000000, 0x0010000000000000, 0x20000000000000, 0x0040000000000000, 0x0080000000000000, 000000000000000000,
	0x0200000000000000, 0x0400000000000000, 0x0800000000000000, 0x1000000000000000, 0x2000000000000000, 0x4000000000000000, 0x8000000000000000, 000000000000000000,
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000,
	000000000000000000, 000000000000000000, 000000000000000000, 000000000000000000, 0000000000000000, 000000000000000000, 000000000000000000, 000000000000000000
};

// Pre-Calculated Move tables: Square-Index

const int MoveUpSquareIndex[64] = {
	8, 9, 10, 11, 12, 13, 14, 15,
	16, 17, 18, 19, 20, 21, 22, 23,
	24, 25, 26, 27, 28, 29, 30, 31,
	32, 33, 34, 35, 36, 37, 38, 39,
	40, 41, 42, 43, 44, 45, 46, 47,
	48, 49, 50, 51, 52, 53, 54, 55,
	56, 57, 58, 59, 60, 61, 62, 63,
	56, 57, 58, 59, 60, 61, 62, 63
};

const int MoveUpRightSquareIndex[64] = {
	0, 8, 9, 10, 11, 12, 13, 14,
	8, 16, 17, 18, 19, 20, 21, 22,
	16, 24, 25, 26, 27, 28, 29, 30,
	24, 32, 33, 34, 35, 36, 37, 38,
	32, 40, 41, 42, 43, 44, 45, 46,
	40, 48, 49, 50, 51, 52, 53, 54,
	48, 56, 57, 58, 59, 60, 61, 62,
	56, 57, 58, 59, 60, 61, 62, 63
};

const int MoveRightSquareIndex[64] = {
	0, 0, 1, 2, 3, 4, 5, 6,
	8, 8, 9, 10, 11, 12, 13, 14,
	16, 16, 17, 18, 19, 20, 21, 22,
	24, 24, 25, 26, 27, 28, 29, 30,
	32, 32, 33, 34, 35, 36, 37, 38,
	40, 40, 41, 42, 43, 44, 45, 46,
	48, 48, 49, 50, 51, 52, 53, 54,
	56, 56, 57, 58, 59, 60, 61, 62
};

const int MoveDownRightSquareIndex[64] = {
	0, 1, 2, 3, 4, 5, 6, 7,
	8, 0, 1, 2, 3, 4, 5, 6,
	16, 8, 9, 10, 11, 12, 13, 14,
	24, 16, 17, 18, 19, 20, 21, 22,
	32, 24, 25, 26, 27, 28, 29, 30,
	40, 32, 33, 34, 35, 36, 37, 38,
	48, 40, 41, 42, 43, 44, 45, 46,
	56, 48, 49, 50, 51, 52, 53, 54
};

const int MoveDownSquareIndex[64] = {
	0, 1, 2, 3, 4, 5, 6, 7,
	0, 1, 2, 3, 4, 5, 6, 7,
	8, 9, 10, 11, 12, 13, 14, 15,
	16, 17, 18, 19, 20, 21, 22, 23,
	24, 25, 26, 27, 28, 29, 30, 31,
	32, 33, 34, 35, 36, 37, 38, 39,
	40, 41, 42, 43, 44, 45, 46, 47,
	48, 49, 50, 51, 52, 53, 54, 55
};

const int MoveDownLeftSquareIndex[64] = {
	0, 1, 2, 3, 4, 5, 6, 7,
	1, 2, 3, 4, 5, 6, 7, 15,
	9, 10, 11, 12, 13, 14, 15, 23,
	17, 18, 19, 20, 21, 22, 23, 31,
	25, 26, 27, 28, 29, 30, 31, 39,
	33, 34, 35, 36, 37, 38, 39, 47,
	41, 42, 43, 44, 45, 46, 47, 55,
	49, 50, 51, 52, 53, 54, 55, 63
};

const int MoveLeftSquareIndex[64] = {
	1, 2, 3, 4, 5, 6, 7, 7,
	9, 10, 11, 12, 13, 14, 15, 15,
	17, 18, 19, 20, 21, 22, 23, 23,
	25, 26, 27, 28, 29, 30, 31, 31,
	33, 34, 35, 36, 37, 38, 39, 39,
	41, 42, 43, 44, 45, 46, 47, 47,
	49, 50, 51, 52, 53, 54, 55, 55,
	57, 58, 59, 60, 61, 62, 63, 63
};

const int MoveUpLeftSquareIndex[64] = {
	9, 10, 11, 12, 13, 14, 15, 7,
	17, 18, 19, 20, 21, 22, 23, 15,
	25, 26, 27, 28, 29, 30, 31, 23,
	33, 34, 35, 36, 37, 38, 39, 31,
	41, 42, 43, 44, 45, 46, 47, 39,
	49, 50, 51, 52, 53, 54, 55, 47,
	57, 58, 59, 60, 61, 62, 63, 55,
	56, 57, 58, 59, 60, 61, 62, 63
};

const int MoveKnight1SquareIndex[64] = {
	0, 16, 17, 18, 19, 20, 21, 22,
	8, 24, 25, 26, 27, 28, 29, 30,
	16, 32, 33, 34, 35, 36, 37, 38,
	24, 40, 41, 42, 43, 44, 45, 46,
	32, 48, 49, 50, 51, 52, 53, 54,
	40, 56, 57, 58, 59, 60, 61, 62,
	48, 49, 50, 51, 52, 53, 54, 55,
	56, 57, 58, 59, 60, 61, 62, 63
};

const int  MoveKnight2SquareIndex[64] = {
	0, 1, 8, 9, 10, 11, 12, 13,
	8, 9, 16, 17, 18, 19, 20, 21,
	16, 17, 24, 25, 26, 27, 28, 29,
	24, 25, 32, 33, 34, 35, 36, 37,
	32, 33, 40, 41, 42, 43, 44, 45,
	40, 41, 48, 49, 50, 51, 52, 53,
	48, 49, 56, 57, 58, 59, 60, 61,
	56, 57, 58, 59, 60, 61, 62, 63
};

const int  MoveKnight3SquareIndex[64] = {
	0, 1, 2, 3, 4, 5, 6, 7,
	8, 9, 0, 1, 2, 3, 4, 5,
	16, 17, 8, 9, 10, 11, 12, 13,
	24, 25, 16, 17, 18, 19, 20, 21,
	32, 33, 24, 25, 26, 27, 28, 29,
	40, 41, 32, 33, 34, 35, 36, 37,
	48, 49, 40, 41, 42, 43, 44, 45,
	56, 57, 48, 49, 50, 51, 52, 53
};

const int  MoveKnight4SquareIndex[64] = {
	0, 1, 2, 3, 4, 5, 6, 7,
	8, 9, 10, 11, 12, 13, 14, 15,
	16, 0, 1, 2, 3, 4, 5, 6,
	24, 8, 9, 10, 11, 12, 13, 14,
	32, 16, 17, 18, 19, 20, 21, 22,
	40, 24, 25, 26, 27, 28, 29, 30,
	48, 32, 33, 34, 35, 36, 37, 38,
	56, 40, 41, 42, 43, 44, 45, 46
};

const int  MoveKnight5SquareIndex[64] = {
	0, 1, 2, 3, 4, 5, 6, 7,
	8, 9, 10, 11, 12, 13, 14, 15,
	1, 2, 3, 4, 5, 6, 7, 23,
	9, 10, 11, 12, 13, 14, 15, 31,
	17, 18, 19, 20, 21, 22, 23, 39,
	25, 26, 27, 28, 29, 30, 31, 47,
	33, 34, 35, 36, 37, 38, 39, 55,
	41, 42, 43, 44, 45, 46, 47, 63
};

const int  MoveKnight6SquareIndex[64] = {
	0, 1, 2, 3, 4, 5, 6, 7,
	2, 3, 4, 5, 6, 7, 14, 15,
	10, 11, 12, 13, 14, 15, 22, 23,
	18, 19, 20, 21, 22, 23, 30, 31,
	26, 27, 28, 29, 30, 31, 38, 39,
	34, 35, 36, 37, 38, 39, 46, 47,
	42, 43, 44, 45, 46, 47, 54, 55,
	50, 51, 52, 53, 54, 55, 62, 63
};

const int  MoveKnight7SquareIndex[64] = {
	10, 11, 12, 13, 14, 15, 6, 7,
	18, 19, 20, 21, 22, 23, 14, 15,
	26, 27, 28, 29, 30, 31, 22, 23,
	34, 35, 36, 37, 38, 39, 30, 31,
	42, 43, 44, 45, 46, 47, 38, 39,
	50, 51, 52, 53, 54, 55, 46, 47,
	58, 59, 60, 61, 62, 63, 54, 55,
	56, 57, 58, 59, 60, 61, 62, 63
};

const int  MoveKnight8SquareIndex[64] = {
	17, 18, 19, 20, 21, 22, 23, 7,
	25, 26, 27, 28, 29, 30, 31, 15,
	33, 34, 35, 36, 37, 38, 39, 23,
	41, 42, 43, 44, 45, 46, 47, 31,
	49, 50, 51, 52, 53, 54, 55, 39,
	57, 58, 59, 60, 61, 62, 63, 47,
	48, 49, 50, 51, 52, 53, 54, 55,
	56, 57, 58, 59, 60, 61, 62, 63
};

// Note : Inline Functions to follow
inline unsigned long getSquareIndex(BitBoard b);

//////// Fill Functions ////////////////////

////////////////////////////////////////////
// Fill in straight attacks               //
// Note: Fill excludes attacking piece(s) //
////////////////////////////////////////////

inline BitBoard fillStraightAttacksOccluded(BitBoard g, BitBoard p)
{

	BitBoard a;
	a =fillRightOccluded(g, p);
	a |= fillLeftOccluded(g, p);
	a |= fillUpOccluded(g, p);
	a |= fillDownOccluded(g, p);
	a &= ~g; // exclude attacking pieces
	return a;


	// (Broken into single operations):

	//BitBoard a, b, c, d, e, f, i, j;
	//BitBoard s, t, u, v, w, x, y, z;
	//BitBoard r;
	//const BitBoard m1 = 0xfefefefefefefefe;
	//const BitBoard m2 = 0x7f7f7f7f7f7f7f7f;
	//// up
	//a = g; b = p; s = a; s <<= 8; s &= b; a |= s; t = b; t <<= 8; b &= t; s = a; s <<= 16; s &= b;
	//a |= s; t = b; t <<= 16; b &= t; s = a; s <<= 32; s &= b; a |= s; r = a;
	//// down:
	//c = g; d = p; u = c; u >>= 8; u &= d; c |= u; v = d; v >>= 8; d &= v; u = c; u >>= 16; u &= d;
	//c |= u; v = d; v >>= 16; d &= v; u = c; u >>= 32; u &= d; c |= u; r |= c;
	//// Left:
	//e = g; f = p; f &= m1; w = e; w <<= 1; w &= f; e |= w; x = f; x <<= 1; f &= x; w = e; w <<= 2; w &= f;
	//e |= w; x = f; x <<= 2; f &= x; w = e; w <<= 4; w &= f; e |= w; r |= e;
	//// Right:
	//i = g; j = p; j &= m2; y = i; y >>= 1; y &= j; i |= y; z = j; z >>= 1; j &= z; y = i; y >>= 2; y &= j;
	//i |= y; z = j; z >>= 2; j &= z; y = i; y >>= 4; y &= j; i |= y; r |= i;
	//r &= ~g;
//	return r;
}

////////////////////////////////////////////
// Fill in diagonal attacks               //
// Note: Fill excludes attacking piece(s) //
////////////////////////////////////////////
inline BitBoard fillDiagonalAttacksOccluded(BitBoard g, BitBoard p)
{

	BitBoard a;
	a =  fillUpRightOccluded(g, p);
	a |= fillDownRightOccluded(g, p);
	a |= fillDownLeftOccluded(g, p);
	a |= fillUpLeftOccluded(g, p);
	a &= ~g; // exclude attacking piece(s)
	return a;

	// (Broken into single operations):

	//BitBoard a, b, c, d, e, f, i, j;
	//BitBoard s, t, u, v, w, x, y, z;
	//const BitBoard m1 = 0xfefefefefefefefe;
	//const BitBoard m2 = 0x7f7f7f7f7f7f7f7f;
	//BitBoard r;
	//// UpRight
	//a = g; b = p; b &= m2; s = a; s <<= 7; s &= b; a |= s; t = b; t <<= 7; b &= t; s = a; s <<= 14; s &= b;
	//a |= s; t = b; t <<= 14; b &= t; s = a; s <<= 28; s &= b; a |= s; r = a;
	//// downRight:
	//c = g; d = p; d &= m2; u = c; u >>= 9; u &= d; c |= u; v = d; v >>= 9; d &= v; u = c; u >>= 18; u &= d;
	//c |= u; v = d; v >>= 18; d &= v; u = c; u >>= 36; u &= d; c |= u; r |= c;
	//// DownLeft:
	//e = g; f = p; f &= m1; w = e; w >>= 7; w &= f; e |= w; x = f; x >>= 7; f &= x; w = e; w >>= 14; w &= f;
	//e |= w; x = f; x >>= 14; f &= x; w = e; w >>= 28; w &= f; e |= w; r |= e;
	//// UpLeft:
	//i = g; j = p; j &= m1; y = i; y <<= 9; y &= j; i |= y; z = j; z <<= 9; j &= z; y = i; y <<= 18; y &= j;
	//i |= y; z = j; z <<= 18; j &= z; y = i; y <<= 36; y &= j; i |= y; r |= i;
	////
	//r &= ~g;
	//return r;
}

// A = the attacker,
// S = space available to attacker (including capture squares),
// V = victims (capturable squares - ie all enemy units except K and EP squares)

inline BitBoard getDiagonalMoveSquares(BitBoard A, BitBoard S, BitBoard V)
{
	return (fillUpRightOccluded(A, S & ~(RIGHTMASK & (V << 7)))
			| fillDownRightOccluded(A, S & ~(RIGHTMASK & (V >> 9)))
			| fillDownLeftOccluded(A, S & ~(LEFTMASK & (V >> 7)))
			| fillUpLeftOccluded(A, S & ~(LEFTMASK & (V << 9))))
			& ~A;
}

inline BitBoard getStraightMoveSquares(BitBoard A, BitBoard S, BitBoard V)
{
	return (fillRightOccluded(A, S & ~(RIGHTMASK & (V >> 1)))
			| fillLeftOccluded(A, S & ~(LEFTMASK & (V << 1)))
			| fillUpOccluded(A, S & ~(V << 8))
			| fillDownOccluded(A, S & ~(V >> 8)))
			& ~A;
}

////////////////////////////////////////////
// Fill in king attacks                   //
// Note: Fill excludes attacking piece(s) //
////////////////////////////////////////////
inline BitBoard fillKingAttacksOccluded(BitBoard g, BitBoard p)
{
	BitBoard a, b;
	BitBoard t, u;
	a = g; t = g; t <<= 1; t &= LEFTMASK; a |= t;
	b = a; b <<= 8; a |= b; u = a; u >>= 1; u &= RIGHTMASK; a |= u;
	b = a; b >>= 8; a |= b; a &= ~g; a &= p;
	return a;
}

inline BitBoard fillKingAttacks(BitBoard g)
{
	BitBoard a, b;
	BitBoard t, u;
	a = g; t = g; t <<= 1; t &= LEFTMASK; a |= t;
	b = a; b <<= 8; a |= b; u = a; u >>= 1; u &= RIGHTMASK; a |= u;
	b = a; b >>= 8; a |= b; a &= ~g;
	return a;
}

////////////////////////////////////////////
// Fill in knight attacks                 //
// Note: Fill excludes attacking piece(s) //
////////////////////////////////////////////
inline BitBoard fillKnightAttacksOccluded(BitBoard g, BitBoard p)
{
	BitBoard l1 = (g >> 1) & 0x7f7f7f7f7f7f7f7f;
	BitBoard l2 = (g >> 2) & 0x3f3f3f3f3f3f3f3f;
	BitBoard r1 = (g << 1) & 0xfefefefefefefefe;
	BitBoard r2 = (g << 2) & 0xfcfcfcfcfcfcfcfc;
	BitBoard h1 = l1 | r1;
	BitBoard h2 = l2 | r2;
	return p &((h1 << 16) | (h1 >> 16) | (h2 << 8) | (h2 >> 8));

}

inline BitBoard FillKnightAttacks(BitBoard g)
{
	BitBoard l1 = (g >> 1) & 0x7f7f7f7f7f7f7f7f;
	BitBoard l2 = (g >> 2) & 0x3f3f3f3f3f3f3f3f;
	BitBoard r1 = (g << 1) & 0xfefefefefefefefe;
	BitBoard r2 = (g << 2) & 0xfcfcfcfcfcfcfcfc;
	BitBoard h1 = l1 | r1;
	BitBoard h2 = l2 | r2;
	return (h1 << 16) | (h1 >> 16) | (h2 << 8) | (h2 >> 8);
}

inline BitBoard fillUpOccluded(BitBoard g, BitBoard p)
{
	// Note: Fill includes pieces.
	g |= p & (g <<  8);
	p &=     (p <<  8);
	g |= p & (g << 16);
	p &=     (p << 16);
	g |= p & (g << 32);
	return g;
}

inline BitBoard fillDownOccluded(BitBoard g, BitBoard p)
{
	// Note: Fill includes pieces.
	g |= p & (g >>  8);
	p &=     (p >>  8);
	g |= p & (g >> 16);
	p &=     (p >> 16);
	g |= p & (g >> 32);
	return g;
}

inline BitBoard fillLeftOccluded(BitBoard g, BitBoard p)
{
	// Note: Fill includes pieces.
	p &= 0xfefefefefefefefe;
	g |= p & (g << 1);
	p &=     (p << 1);
	g |= p & (g << 2);
	p &=     (p << 2);
	g |= p & (g << 4);
	return g;
}

inline BitBoard fillRightOccluded(BitBoard g, BitBoard p)
{
	// Note: Fill includes pieces.
	p &= 0x7f7f7f7f7f7f7f7f;
	g |= p & (g >> 1);
	p &=     (p >> 1);
	g |= p & (g >> 2);
	p &=     (p >> 2);
	g |= p & (g >> 4);
	return g;
}

inline BitBoard fillUpRightOccluded(BitBoard g, BitBoard p)
{
	// Note: Fill includes pieces.
	p &= 0x7f7f7f7f7f7f7f7f; // left wall
	g |= p & (g <<  7);
	p &=     (p <<  7);
	g |= p & (g << 14);
	p &=     (p << 14);
	g |= p & (g << 28);
	return g;
}

inline BitBoard fillDownRightOccluded(BitBoard g, BitBoard p)
{
	// Note: Fill includes pieces.
	p &= 0x7f7f7f7f7f7f7f7f; // left wall
	g |= p & (g >>  9);
	p &=     (p >>  9);
	g |= p & (g >> 18);
	p &=     (p >> 18);
	g |= p & (g >> 36);
	return g;
}


inline BitBoard fillDownLeftOccluded(BitBoard g, BitBoard p)
{
	// Note: Fill includes pieces.
	p &= 0xfefefefefefefefe; // right wall
	g |= p & (g >> 7);
	p &=     (p >> 7);
	g |= p & (g >> 14);
	p &=     (p >> 14);
	g |= p & (g >> 28);
	return g;
}

inline BitBoard fillUpLeftOccluded(BitBoard g, BitBoard p)
{
	// Note: Fill includes pieces.
	p &= 0xfefefefefefefefe; // right wall
	g |= p & (g << 9);
	p &=     (p << 9);
	g |= p & (g << 18);
	p &=     (p << 18);
	g |= p & (g << 36);
	return g;
}

inline BitBoard moveUpSingleOccluded(BitBoard g, BitBoard p)
{
	return (p & (g << 8));
}

inline BitBoard moveUpRightSingleOccluded(BitBoard g, BitBoard p)
{
	p &= 0x7f7f7f7f7f7f7f7f;
	return (p & (g << 7));
}

inline BitBoard moveRightSingleOccluded(BitBoard g, BitBoard p)
{
	p &= 0x7f7f7f7f7f7f7f7f;
	return (p & (g >> 1));
}

inline BitBoard moveDownRightSingleOccluded(BitBoard g, BitBoard p)
{
	p &= 0x7f7f7f7f7f7f7f7f;
	return (p & (g >> 9));
}

inline BitBoard moveDownSingleOccluded(BitBoard g, BitBoard p)
{
	return (p & (g >> 8));
}

inline BitBoard moveDownLeftSingleOccluded(BitBoard g, BitBoard p)
{
	p &= 0xfefefefefefefefe;
	return (p & (g >> 7));
}

inline BitBoard moveLeftSingleOccluded(BitBoard g, BitBoard p)
{
	p &= 0xfefefefefefefefe;
	return (p & (g << 1));
}

inline BitBoard moveUpLeftSingleOccluded(BitBoard g, BitBoard p)
{
	p &= 0xfefefefefefefefe;
	return (p & (g << 9));
}

inline BitBoard MoveDownLeftRightSingle(BitBoard g)
{
	return	(0xfefefefefefefefe & (g >> 7)) |	// DownLeft
			(0x7f7f7f7f7f7f7f7f & (g >> 9));		// DownRight
}

inline BitBoard MoveUpLeftRightSingle(BitBoard g) {
	return	(0xfefefefefefefefe & (g << 9)) |	// UpLeft
			(0x7f7f7f7f7f7f7f7f & (g << 7));		// UpRight
}

inline BitBoard moveKnight1Occluded(BitBoard g, BitBoard p)
{
	p &= ~0x8080808080808000;
	return (p & (g << 15));
}

inline BitBoard moveKnight2Occluded(BitBoard g, BitBoard p)
{
	p &= ~0xC0C0C0C0C0C0C0C0;
	return (p & (g << 6));
}

inline BitBoard moveKnight3Occluded(BitBoard g, BitBoard p)
{
	p &= ~0x0000C0C0C0C0C0C0;
	return (p & (g >> 10));
}

inline BitBoard moveKnight4Occluded(BitBoard g, BitBoard p)
{
	p &= ~0x0000008080808080;
	return (p & (g >> 17));
}

inline BitBoard moveKnight5Occluded(BitBoard g, BitBoard p)
{
	p &= ~0x0001010101010101;
	return (p & (g >> 15));
}

inline BitBoard moveKnight6Occluded(BitBoard g, BitBoard p)
{
	p &= ~0x0303030303030303;
	return (p & (g >> 6));
}

inline BitBoard moveKnight7Occluded(BitBoard g, BitBoard p)
{
	p &= ~0x0303030303030000;
	return (p & (g << 10));
}

inline BitBoard moveKnight8Occluded(BitBoard g, BitBoard p)
{
	p &= ~0x0101010101000000;
	return (p & (g << 17));
}

inline int popCount(const BitBoard & B)
{
#if defined( _USE_POPCNT_INSTRUCTION) && defined(_WIN64) && defined(_MSC_VER)
	return static_cast<int>(__popcnt64(B));
#else
	// This routine comes from:
	// Knuth, TAoCP Vol 4: Fascicle 1, (no. 62)
	BitBoard A;
	A = B - ((B >> 1) & 0x5555555555555555);
	A = (A & 0x3333333333333333) +
		((A >> 2) & 0x3333333333333333);
	A = (A + (A >> 4)) & 0x0f0f0f0f0f0f0f0f;
	return static_cast<int>((A * 0x0101010101010101) >> 56);
#endif
}

inline unsigned long getSquareIndex(BitBoard b)
{
	unsigned long n = 0;

	// note: bit scans performed terribly in this context (at least, on my machine),
	// so just going with the DeBruijn Multiplication

// #if defined(_USE_BITSCAN_INSTRUCTIONS)

// #if defined(_MSC_VER)
//     // Important: a and b must be initialised first !
//     _BitScanForward64(&n, b);
// #elif defined(__GNUC__) || defined(__clang__)
//     n = __builtin_ctzll(b);
// #endif

// #else

	// alternative method for non-x86-64, using DeBruijn Multiplication:
	// see (https://chessprogramming.wikispaces.com/BitScan)
	// credit: Kim Walisch, Gerd Isenberg et al.

	const BitBoard db64 = 0x03f79d71b4cb0a89;

	const int tbl[64] = {
		0, 47,  1, 56, 48, 27,  2, 60,
		57, 49, 41, 37, 28, 16,  3, 61,
		54, 58, 35, 52, 50, 42, 21, 44,
		38, 32, 29, 23, 17, 11,  4, 62,
		46, 55, 26, 59, 40, 36, 15, 53,
		34, 51, 20, 43, 31, 22, 10, 45,
		25, 39, 14, 33, 19, 30,  9, 24,
		13, 18,  8, 12,  7,  6,  5, 63
	};

	// BitScanForward:
	n = tbl[((b ^ (b - 1)) * db64) >> 58];

// #endif // defined(_USE_BITSCAN_INSTRUCTIONS)

	// todo: can also try our old friend, std::bitset::_Find_first()
	// also, C++20 has some bit-scanning functions now in the <bit> header ...

	return n;
}

// getFirstAndLastPiece()
// Note: starts from Bottom Right (H1 / bit 0), ends Top-Left (A8 / bit 63)
inline void getFirstAndLastPiece(const BitBoard& B, unsigned long& a, unsigned long& b)
{

#if defined(_USE_BITSCAN_INSTRUCTIONS)
	// perform Bitscans to determine start and finish squares;
#if defined(_MSC_VER)
	// Important: a and b must be initialised first !
	_BitScanReverse64(&b, B);
	_BitScanForward64(&a, B);
#elif defined(__GNUC__) || defined(__clang__)
	b = 63 - __builtin_clzll(B);
	a = __builtin_ctzll(B);
#endif

#else

	// alternative method for non-x86-64, using DeBruijn Multiplication:
	// see (https://chessprogramming.wikispaces.com/BitScan)
	// credit: Kim Walisch, Gerd Isenberg et al.

	const BitBoard db64 = 0x03f79d71b4cb0a89;

	const int tbl[64] = {
		0, 47,  1, 56, 48, 27,  2, 60,
		57, 49, 41, 37, 28, 16,  3, 61,
		54, 58, 35, 52, 50, 42, 21, 44,
		38, 32, 29, 23, 17, 11,  4, 62,
		46, 55, 26, 59, 40, 36, 15, 53,
		34, 51, 20, 43, 31, 22, 10, 45,
		25, 39, 14, 33, 19, 30,  9, 24,
		13, 18,  8, 12,  7,  6,  5, 63
	};

	// BitScanForward:
	a = tbl[((B ^ (B - 1)) * db64) >> 58];

	// BitScanReverse:
	BitBoard A = B;
	A |= A >> 1;
	A |= A >> 2;
	A |= A >> 4;
	A |= A >> 8;
	A |= A >> 16;
	A |= A >> 32;
	b = tbl[(A * db64) >> 58];

#endif
}

} // namespace juddperft
#endif // _MOVEGEN
